<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SubmitRichiestaServlet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mensadigitale Maven Webapp</a> &gt; <a href="index.source.html" class="el_package">business.richieste</a> &gt; <span class="el_source">SubmitRichiestaServlet.java</span></div><h1>SubmitRichiestaServlet.java</h1><pre class="source lang-java linenums">package business.richieste;

import business.consumatore.ConsumatoreBean;
import java.io.IOException;
import java.io.PrintWriter;
import java.sql.SQLException;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import storage.manager.ConsumatoreDao;
import storage.manager.RichiestaDao;

public class SubmitRichiestaServlet extends HttpServlet {
  private static final long serialVersionUID = 1L;
<span class="fc" id="L18">  private static RichiestaDao richiestaDao = new RichiestaDao();</span>
<span class="fc" id="L19">  private static ConsumatoreDao consumatoreDao = new ConsumatoreDao();</span>
<span class="fc" id="L20">  private final int annoInizio = 1900;</span>
<span class="fc" id="L21">  private final int annoFine = 2020;</span>
<span class="fc" id="L22">  private final String[] listaProvince = {&quot;AG&quot;, &quot;AL&quot;, &quot;AN&quot;, &quot;AO&quot;, &quot;AR&quot;, &quot;AP&quot;, &quot;AT&quot;, &quot;AV&quot;, &quot;BA&quot;,</span>
      &quot;BT&quot;, &quot;BL&quot;, &quot;BN&quot;, &quot;BG&quot;, &quot;BI&quot;, &quot;BO&quot;, &quot;BZ&quot;, &quot;BS&quot;, &quot;BR&quot;, &quot;CA&quot;, &quot;CL&quot;, &quot;CB&quot;, &quot;CE&quot;, &quot;CT&quot;, &quot;CZ&quot;,
      &quot;CH&quot;, &quot;CO&quot;, &quot;CS&quot;, &quot;CR&quot;, &quot;KR&quot;, &quot;CN&quot;, &quot;EN&quot;, &quot;FM&quot;, &quot;FE&quot;, &quot;FI&quot;, &quot;FG&quot;, &quot;FC&quot;, &quot;FR&quot;, &quot;GE&quot;, &quot;GO&quot;,
      &quot;GR&quot;, &quot;IM&quot;, &quot;IS&quot;, &quot;AQ&quot;, &quot;SP&quot;, &quot;LT&quot;, &quot;LE&quot;, &quot;LC&quot;, &quot;LI&quot;, &quot;LO&quot;, &quot;LU&quot;, &quot;MC&quot;, &quot;MN&quot;, &quot;MS&quot;, &quot;MT&quot;,
      &quot;ME&quot;, &quot;MI&quot;, &quot;MO&quot;, &quot;MB&quot;, &quot;NA&quot;, &quot;NO&quot;, &quot;NU&quot;, &quot;OR&quot;, &quot;PA&quot;, &quot;PD&quot;, &quot;PR&quot;, &quot;PV&quot;, &quot;PG&quot;, &quot;PU&quot;, &quot;PE&quot;,
      &quot;PC&quot;, &quot;PI&quot;, &quot;PT&quot;, &quot;PN&quot;, &quot;PZ&quot;, &quot;PO&quot;, &quot;RC&quot;, &quot;RG&quot;, &quot;RA&quot;, &quot;RE&quot;, &quot;RI&quot;, &quot;RN&quot;, &quot;RM&quot;, &quot;RO&quot;, &quot;SA&quot;,
      &quot;SS&quot;, &quot;SV&quot;, &quot;SI&quot;, &quot;SR&quot;, &quot;SO&quot;, &quot;SU&quot;, &quot;TA&quot;, &quot;TE&quot;, &quot;TR&quot;, &quot;TO&quot;, &quot;TP&quot;, &quot;TN&quot;, &quot;TV&quot;, &quot;TS&quot;, &quot;UD&quot;,
      &quot;VA&quot;, &quot;VE&quot;, &quot;VB&quot;, &quot;VC&quot;, &quot;VR&quot;, &quot;VV&quot;, &quot;VI&quot;, &quot;VT&quot;};

  public SubmitRichiestaServlet() {
<span class="fc" id="L32">    super();</span>
<span class="fc" id="L33">  }</span>

  protected void doGet(HttpServletRequest request, HttpServletResponse response)
      throws ServletException, IOException {
<span class="nc" id="L37">    doPost(request, response);</span>
<span class="nc" id="L38">  }</span>

  protected void doPost(HttpServletRequest request, HttpServletResponse response)
      throws ServletException, IOException {
<span class="fc" id="L42">    String cognome = request.getParameter(&quot;cognome&quot;);</span>
<span class="fc" id="L43">    String nome = request.getParameter(&quot;nome&quot;);</span>
<span class="fc" id="L44">    String dataDiNascita = request.getParameter(&quot;dataDiNascita&quot;);</span>
<span class="fc" id="L45">    String provinciaDiNascita = request.getParameter(&quot;provinciaDiNascita&quot;);</span>
<span class="fc" id="L46">    String comuneDiNascita = request.getParameter(&quot;comuneDiNascita&quot;);</span>
<span class="fc" id="L47">    String codiceFiscale = request.getParameter(&quot;codiceFiscale&quot;);</span>
<span class="fc" id="L48">    String cittadinanza = request.getParameter(&quot;cittadinanza&quot;);</span>
<span class="fc" id="L49">    boolean rifugiato = Boolean.getBoolean(request.getParameter(&quot;rifugiato&quot;));</span>
<span class="fc" id="L50">    boolean residenzaNucleo = Boolean.getBoolean(request.getParameter(&quot;residenzaNucleo&quot;));</span>
<span class="fc" id="L51">    String indirizzo = request.getParameter(&quot;indirizzo&quot;);</span>
<span class="fc" id="L52">    String telefono = request.getParameter(&quot;telefono&quot;); // Can be null</span>
<span class="fc" id="L53">    String cellulare = request.getParameter(&quot;cellulare&quot;); // Can be null</span>
<span class="fc" id="L54">    String email = request.getParameter(&quot;email&quot;);</span>
<span class="fc" id="L55">    String confermaEmail = request.getParameter(&quot;confermaEmail&quot;);</span>

<span class="fc" id="L57">    boolean prelazione = Boolean.valueOf(request.getParameter(&quot;prelazione&quot;));</span>
<span class="fc" id="L58">    boolean responsabilita = Boolean.valueOf(request.getParameter(&quot;responsabilita&quot;));</span>

<span class="pc bpc" id="L60" title="2 of 6 branches missed.">    boolean checkCognome = cognome != null &amp;&amp; (cognome.length() &gt;= 2 &amp;&amp; cognome.length() &lt;= 50)</span>
<span class="fc bfc" id="L61" title="All 2 branches covered.">        &amp;&amp; onlyLetters(cognome);</span>
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">    boolean checkNome =</span>
<span class="pc bpc" id="L63" title="1 of 6 branches missed.">        nome != null &amp;&amp; (nome.length() &gt;= 2 &amp;&amp; nome.length() &lt;= 50) &amp;&amp; onlyLetters(nome);</span>
<span class="pc bpc" id="L64" title="1 of 2 branches missed.">    boolean checkDataDiNascita =</span>
<span class="pc bpc" id="L65" title="1 of 4 branches missed.">        dataDiNascita != null &amp;&amp; dataDiNascita.length() == 10 &amp;&amp; validateData(dataDiNascita);</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">    boolean checkProvinciaDiNascita =</span>
<span class="fc bfc" id="L67" title="All 2 branches covered.">        provinciaDiNascita != null &amp;&amp; validateProvincia(provinciaDiNascita);</span>
<span class="pc bpc" id="L68" title="1 of 2 branches missed.">    boolean checkComuneDiNascita =</span>
<span class="pc bpc" id="L69" title="1 of 4 branches missed.">        comuneDiNascita != null &amp;&amp; (comuneDiNascita.length() &gt;= 2 &amp;&amp; comuneDiNascita.length() &lt;= 50)</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">            &amp;&amp; onlyLetters(comuneDiNascita);</span>
<span class="pc bpc" id="L71" title="1 of 4 branches missed.">    boolean checkCodiceFiscale = codiceFiscale != null &amp;&amp; validateCodiceFiscale(codiceFiscale);</span>
<span class="fc bfc" id="L72" title="All 2 branches covered.">    boolean checkCittadinanza = cittadinanza != null</span>
<span class="pc bpc" id="L73" title="1 of 6 branches missed.">        &amp;&amp; (cittadinanza.length() &gt;= 2 &amp;&amp; cittadinanza.length() &lt;= 50) &amp;&amp; onlyLetters(cittadinanza);</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">    boolean checkIndirizzo =</span>
<span class="pc bpc" id="L75" title="1 of 4 branches missed.">        indirizzo != null &amp;&amp; (indirizzo.length() &gt;= 4 &amp;&amp; indirizzo.length() &lt;= 100);</span>
<span class="pc bpc" id="L76" title="1 of 6 branches missed.">    boolean checkTelefono = telefono == null || (telefono.length() &gt;= 6 &amp;&amp; telefono.length() &lt;= 20);</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">    boolean checkCellulare =</span>
<span class="pc bpc" id="L78" title="1 of 4 branches missed.">        cellulare == null || (cellulare.length() &gt;= 6 &amp;&amp; cellulare.length() &lt;= 20);</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">    boolean checkEmail =</span>
<span class="fc bfc" id="L80" title="All 4 branches covered.">        email != null &amp;&amp; validateEmail(email) &amp;&amp; email.equalsIgnoreCase(confermaEmail);</span>

<span class="fc bfc" id="L82" title="All 22 branches covered.">    if (!(checkCognome &amp;&amp; checkNome &amp;&amp; checkDataDiNascita &amp;&amp; checkProvinciaDiNascita</span>
        &amp;&amp; checkComuneDiNascita &amp;&amp; checkCodiceFiscale &amp;&amp; checkCittadinanza &amp;&amp; checkIndirizzo
        &amp;&amp; checkTelefono &amp;&amp; checkCellulare &amp;&amp; checkEmail)) {
<span class="fc" id="L85">      throw new IllegalArgumentException();</span>
    }

<span class="pc bpc" id="L88" title="2 of 4 branches missed.">    if (!prelazione || !responsabilita) {</span>
<span class="nc" id="L89">      throw new IllegalArgumentException();</span>
    }

    try {
<span class="fc" id="L93">      ConsumatoreBean studente = null;</span>
<span class="fc" id="L94">      studente = (ConsumatoreBean) request.getSession().getAttribute(&quot;utente&quot;);</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">      if ((studente.isDocente())) {</span>
<span class="nc" id="L96">        return;</span>
      }
<span class="fc" id="L98">      studente.setDataDiNascita(new SimpleDateFormat(&quot;yyyy/MM/dd&quot;).parse(dataDiNascita));</span>
<span class="fc" id="L99">      studente.setProvinciaNascita(provinciaDiNascita);</span>
<span class="fc" id="L100">      studente.setComuneNascita(comuneDiNascita);</span>
<span class="fc" id="L101">      studente.setCittadinanza(cittadinanza);</span>
<span class="fc" id="L102">      studente.setRifugiato(rifugiato);</span>
<span class="fc" id="L103">      studente.setResidenzaNucleoFamiliare(residenzaNucleo);</span>
<span class="fc" id="L104">      studente.setIndirizzo(indirizzo);</span>
<span class="fc" id="L105">      studente.setTelefono(telefono);</span>
<span class="fc" id="L106">      studente.setCellulare(cellulare);</span>


<span class="fc" id="L109">      RichiestaBean nuovaRichiesta = new RichiestaBean(email);</span>
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">      if (consumatoreDao.doRetrieveByKey(studente.getEmail()) != null) {</span>
<span class="fc" id="L111">        consumatoreDao.doUpdate(studente);</span>
      } else {
<span class="nc" id="L113">        consumatoreDao.doSave(studente);</span>
      }

<span class="fc" id="L116">      richiestaDao.doSave(nuovaRichiesta);</span>

      /*
       * Check if correct
       */
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">      if (response.getWriter() != null) {</span>
<span class="nc" id="L122">        PrintWriter out = response.getWriter();</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (richiestaDao.doRetrieveByKey(nuovaRichiesta.getId()) != null) {</span>
<span class="nc" id="L124">          out.println(&quot;&lt;script type=\&quot;text/javascript\&quot;&gt;&quot;);</span>
<span class="nc" id="L125">          out.println(&quot;alert(\&quot;La richiesta � stata inoltrata con successo\&quot;)&quot;);</span>
<span class="nc" id="L126">          out.println(&quot;&lt;/script&gt;&quot;);</span>
        } else {
<span class="nc" id="L128">          out.println(&quot;&lt;script type=\&quot;text/javascript\&quot;&gt;&quot;);</span>
<span class="nc" id="L129">          out.println(&quot;alert(\&quot;Inoltro della richiesta fallito. Ritentare pi� tardi\&quot;)&quot;);</span>
<span class="nc" id="L130">          out.println(&quot;&lt;/script&gt;&quot;);</span>
        }
      }
<span class="nc" id="L133">    } catch (SQLException | ParseException e) {</span>
<span class="nc" id="L134">      e.printStackTrace();</span>
<span class="fc" id="L135">    }</span>
<span class="fc" id="L136">  }</span>

  private boolean onlyLetters(String word) {
<span class="fc" id="L139">    char[] array = word.toCharArray();</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">    for (char c : array) {</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">      if (!Character.isLetter(c)) {</span>
<span class="fc" id="L142">        return false;</span>
      }
    }
<span class="fc" id="L145">    return true;</span>
  }

  private boolean validateData(String data) {
<span class="pc bpc" id="L149" title="2 of 4 branches missed.">    if (data.charAt(2) != '/' || data.charAt(5) != '/') {</span>
<span class="nc" id="L150">      return false;</span>
    }
<span class="fc" id="L152">    int day = Integer.parseInt(data.subSequence(0, 2).toString());</span>
<span class="fc" id="L153">    int month = Integer.parseInt(data.substring(3, 5));</span>
<span class="fc" id="L154">    int year = Integer.parseInt(data.substring(6, 10));</span>
<span class="pc bpc" id="L155" title="2 of 4 branches missed.">    if (year &lt; annoInizio || year &gt; annoFine) {</span>
<span class="nc" id="L156">      return false;</span>
    }
<span class="pc bpc" id="L158" title="7 of 14 branches missed.">    if (month == 1 || month == 3 || month == 5 || month == 7 || month == 8 || month == 10</span>
        || month == 12) { // mese di 31
<span class="nc bnc" id="L160" title="All 4 branches missed.">      if (!(day &gt;= 1 &amp;&amp; day &lt;= 31)) {</span>
<span class="nc" id="L161">        return false;</span>
      }
<span class="pc bpc" id="L163" title="4 of 8 branches missed.">    } else if (month == 11 || month == 4 || month == 6 || month == 9) { // mese di 30</span>
<span class="nc bnc" id="L164" title="All 4 branches missed.">      if (!(day &gt;= 1 &amp;&amp; day &lt;= 30)) {</span>
<span class="nc" id="L165">        return false;</span>
      }
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">    } else if (month == 2) { // mese == febbraio</span>
<span class="pc bpc" id="L168" title="3 of 6 branches missed.">      if (year % 4 == 0 &amp;&amp; (year % 100 != 0 || year % 400 == 0)) { // anno bisestile</span>
<span class="pc bpc" id="L169" title="2 of 4 branches missed.">        if (!(day &gt;= 1 &amp;&amp; day &lt;= 29)) {</span>
<span class="fc" id="L170">          return false;</span>
        }
      } else {
<span class="pc bpc" id="L173" title="2 of 4 branches missed.">        if (!(day &gt;= 1 &amp;&amp; day &lt;= 28)) {</span>
<span class="nc" id="L174">          return false;</span>
        }
      }
    } else {
<span class="nc" id="L178">      return false;</span>
    }
<span class="fc" id="L180">    return true;</span>
  }

  private boolean validateProvincia(String provincia) {
<span class="fc bfc" id="L184" title="All 2 branches covered.">    for (String esistente : listaProvince) {</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">      if (provincia.equalsIgnoreCase(esistente)) {</span>
<span class="fc" id="L186">        return true;</span>
      }
    }
<span class="fc" id="L189">    return false;</span>
  }

  private boolean validateCodiceFiscale(String cf) {
<span class="fc bfc" id="L193" title="All 2 branches covered.">    if (!cf.matches(&quot;^[0-9A-Z]{16}$&quot;)) {</span>
<span class="fc" id="L194">      return false;</span>
    }

<span class="fc" id="L197">    int s = 0;</span>
<span class="fc" id="L198">    String evenMap = &quot;BAFHJNPRTVCESULDGIMOQKWZYX&quot;;</span>

<span class="fc bfc" id="L200" title="All 2 branches covered.">    for (int i = 0; i &lt; 15; i++) {</span>
<span class="fc" id="L201">      int c = cf.charAt(i);</span>

      int n;

<span class="pc bpc" id="L205" title="1 of 4 branches missed.">      if ('0' &lt;= c &amp;&amp; c &lt;= '9') {</span>
<span class="fc" id="L206">        n = c - '0';</span>
      } else {
<span class="fc" id="L208">        n = c - 'A';</span>
      }

<span class="fc bfc" id="L211" title="All 2 branches covered.">      if ((i &amp; 1) == 0) {</span>
<span class="fc" id="L212">        n = evenMap.charAt(n) - 'A';</span>
      }
<span class="fc" id="L214">      s += n;</span>
    }

<span class="pc bpc" id="L217" title="1 of 2 branches missed.">    if (s % 26 + 'A' != cf.charAt(15)) {</span>
<span class="nc" id="L218">      return false;</span>
    }
<span class="fc" id="L220">    return true;</span>
  }

  private boolean validateEmail(String email) {
<span class="fc" id="L224">    String regex = &quot;^[\\w-\\.]+@([\\w-]+\\.)+[\\w-]{2,4}$&quot;;</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">    if (!(email.matches(regex))) {</span>
<span class="fc" id="L226">      return false;</span>
    }

<span class="fc" id="L229">    return true;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>